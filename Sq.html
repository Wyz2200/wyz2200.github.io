<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ç°¡ç´„è¨˜å¸³ï¼ˆVision Pro å¼æ¯›ç»ç’ƒï¼‰</title>
<style>
  :root{
    --bg-1: #efe6dc; /* ç±³ç™½åŸºåº• */
    --bg-2: #e2d2c0; /* ç±³å’–å•¡æ¼¸å±¤ */
    --card-bg: rgba(255,255,255,0.18);
    --card-border: rgba(255,255,255,0.25);
    --accent: rgba(48,41,38,0.95);
    --accent-soft: rgba(48,41,38,0.65);
    --success: #2ecc71;
    --danger: #e74c3c;
    --glass-blur: 14px;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", "Helvetica Neue", Arial;
  }

  /* Background like milky coffee with subtle grain */
  body{
    margin:0;
    min-height:100vh;
    background: linear-gradient(160deg, var(--bg-1) 0%, var(--bg-2) 100%);
    display:flex;
    align-items:center;
    justify-content:center;
    padding:32px;
    color:var(--accent);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    background-attachment: fixed;
  }

  /* container to give centered app card with drop */
  .app{
    width:100%;
    max-width:1100px;
    display:grid;
    grid-template-columns: 360px 1fr;
    gap:28px;
    align-items:start;
  }

  /* Left panel (controls) and right panel (list) */
  .panel{
    background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
    border-radius:20px;
    padding:20px;
    box-shadow: 0 10px 30px rgba(17,12,10,0.12);
    position:relative;
    backdrop-filter: blur(var(--glass-blur));
    -webkit-backdrop-filter: blur(var(--glass-blur));
    border: 1px solid var(--card-border);
  }

  /* subtle top highlight to mimic Vision Pro cards */
  .panel::before{
    content:"";
    position:absolute;
    inset:0;
    border-radius:inherit;
    pointer-events:none;
    box-shadow: inset 0 1px 0 rgba(255,255,255,0.06);
  }

  /* Header */
  header h1{
    margin:0 0 8px 0;
    font-size:20px;
    letter-spacing:0.2px;
  }
  header p{
    margin:0;
    color:var(--accent-soft);
    font-size:13px;
  }

  /* balance card */
  .balance{
    margin-top:16px;
    display:flex;
    gap:12px;
    align-items:center;
  }
  .balance .big{
    flex:1;
    font-size:28px;
    font-weight:700;
  }
  .balance .small{
    color:var(--accent-soft);
    font-size:13px;
  }

  /* form */
  form.row{
    display:grid;
    grid-template-columns: 1fr 100px;
    gap:10px;
    margin-top:18px;
  }
  input, select{
    padding:10px 12px;
    border-radius:12px;
    border:1px solid rgba(0,0,0,0.06);
    background: rgba(255,255,255,0.6);
    outline:none;
    font-size:14px;
    box-shadow: 0 2px 6px rgba(17,12,10,0.03);
  }
  input:focus, select:focus, textarea:focus{
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
  }
  .controls{
    margin-top:14px;
    display:flex;
    gap:10px;
    align-items:center;
  }
  button.btn{
    padding:10px 12px;
    border-radius:12px;
    border:none;
    cursor:pointer;
    font-weight:600;
    background: linear-gradient(180deg, rgba(255,255,255,0.14), rgba(255,255,255,0.06));
    color:var(--accent);
    box-shadow: 0 6px 18px rgba(17,12,10,0.06);
  }
  button.primary{
    background: linear-gradient(180deg, rgba(255,255,255,0.22), rgba(255,255,255,0.08));
  }
  button.ghost{
    background: transparent;
    border:1px dashed rgba(255,255,255,0.06);
  }

  /* right side: list area */
  .right{
    display:flex;
    flex-direction:column;
    gap:18px;
  }

  /* each transaction card */
  .tx-list{
    display:grid;
    gap:12px;
  }
  .tx{
    display:flex;
    align-items:center;
    gap:12px;
    padding:12px;
    border-radius:14px;
    background: linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.04));
    border:1px solid rgba(255,255,255,0.06);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
  }
  .tx .meta{
    flex:1;
  }
  .tx .title{
    font-weight:700;
    margin-bottom:4px;
  }
  .tx .desc{
    font-size:13px;
    color:var(--accent-soft);
  }
  .tx .amount{
    min-width:120px;
    text-align:right;
    font-weight:700;
    font-size:16px;
  }
  .tag{
    display:inline-block;
    padding:6px 8px;
    border-radius:999px;
    font-size:12px;
    margin-right:6px;
    background: rgba(255,255,255,0.06);
    color:var(--accent-soft);
    border:1px solid rgba(255,255,255,0.03);
  }
  .amount.positive{ color: var(--success); }
  .amount.negative{ color: var(--danger); }

  /* small toolbar on top of list */
  .toolbar{
    display:flex;
    gap:8px;
    align-items:center;
    justify-content:space-between;
  }
  .toolbar .left{
    display:flex;
    gap:8px;
    align-items:center;
  }
  .search{
    min-width:220px;
  }

  /* empty state */
  .empty{
    padding:20px;
    border-radius:12px;
    text-align:center;
    color:var(--accent-soft);
    background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
    border:1px dashed rgba(255,255,255,0.04);
  }

  /* responsive */
  @media (max-width:980px){
    .app{ grid-template-columns: 1fr; padding:0; }
    .panel{ padding:16px; }
  }

  /* small utility */
  .muted{ color:var(--accent-soft); font-size:13px; }
  .flex{ display:flex; gap:8px; align-items:center; }
  .pill{ padding:6px 10px; border-radius:999px; background: rgba(255,255,255,0.04); font-size:13px; }
  .right .summary-row{
    display:flex;
    gap:12px;
  }
  .summary-card{
    flex:1;
    padding:12px;
    border-radius:12px;
    background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
    text-align:center;
    border:1px solid rgba(255,255,255,0.03);
  }
  .summary-card .num{ font-weight:800; font-size:18px; margin-top:6px; }
  .small-note{ font-size:12px; color:var(--accent-soft); margin-top:8px; }
  .tx .actions{ display:flex; gap:8px; margin-left:12px; align-items:center;}
  .icon-btn{
    width:36px;height:36px;border-radius:10px;border:none;background:transparent;cursor:pointer;
  }

</style>
</head>
<body>
  <main class="app" role="application" aria-label="ç°¡ç´„è¨˜å¸³">
    <!-- LEFT: controls -->
    <section class="panel" aria-labelledby="appTitle">
      <header>
        <h1 id="appTitle">ç°¡ç´„è¨˜å¸³</h1>
        <p>Vision Pro é¢¨æ ¼æ¯›ç»ç’ƒä»‹é¢ â€¢ è‡ªå‹•å­˜æª”ï¼ˆlocalStorageï¼‰</p>
      </header>

      <div class="balance" aria-live="polite">
        <div>
          <div class="small">é¤˜é¡</div>
          <div class="big" id="balance">NT$ 0</div>
        </div>
        <div class="small" style="text-align:right">
          <div class="muted">ç¸½æ”¶å…¥ <div id="total-income" class="pill">NT$ 0</div></div>
          <div class="muted">ç¸½æ”¯å‡º <div id="total-expense" class="pill">NT$ 0</div></div>
        </div>
      </div>

      <form id="txForm" class="row" autocomplete="off" aria-label="æ–°å¢æˆ–ç·¨è¼¯å¸³ç›®">
        <input type="text" id="title" placeholder="æ¨™é¡Œï¼ˆä¾‹å¦‚ï¼šæ—©é¤ï¼‰" required />
        <input type="number" id="amount" placeholder="é‡‘é¡" required min="0" step="0.01" />
        <input type="text" id="note" placeholder="å‚™è¨»ï¼ˆå¯é¸ï¼‰" style="grid-column:1 / -1" />
        <div style="display:flex;gap:10px;grid-column:1 / -1;margin-top:6px;">
          <select id="category" aria-label="é¡åˆ¥">
            <option value="food">é¤é£²ï¼ˆfoodï¼‰</option>
            <option value="transport">äº¤é€šï¼ˆtransportï¼‰</option>
            <option value="shopping">è³¼ç‰©ï¼ˆshoppingï¼‰</option>
            <option value="income">æ”¶å…¥ï¼ˆincomeï¼‰</option>
            <option value="others">å…¶ä»–ï¼ˆothersï¼‰</option>
          </select>
          <select id="type" aria-label="æ”¶æ”¯é¡å‹">
            <option value="expense">æ”¯å‡º</option>
            <option value="income">æ”¶å…¥</option>
          </select>
          <input id="date" type="date" style="flex:1" />
        </div>
        <div style="grid-column:1 / -1" class="controls">
          <button type="submit" class="btn primary" id="saveBtn">æ–°å¢</button>
          <button type="button" class="btn ghost" id="resetBtn">æ¸…é™¤è¡¨å–®</button>
          <div style="flex:1"></div>
          <button type="button" class="btn" id="exportBtn">åŒ¯å‡º JSON</button>
          <button type="button" class="btn" id="importBtn">åŒ¯å…¥ JSON</button>
        </div>
      </form>

      <div class="small-note">æç¤ºï¼šé»é¸å³å´æ¯ç­†å¡ç‰‡çš„ç·¨è¼¯éµå¯æŠŠè³‡æ–™å›å¡«åˆ°å·¦å´è¡¨å–®ï¼ˆç·¨è¼¯å¾ŒæŒ‰å„²å­˜ï¼‰</div>
    </section>

    <!-- RIGHT: list & filters -->
    <section class="right">
      <div class="panel">
        <div class="toolbar">
          <div class="left">
            <div class="flex">
              <select id="filterCategory">
                <option value="all">å…¨éƒ¨é¡åˆ¥</option>
                <option value="food">é¤é£²</option>
                <option value="transport">äº¤é€š</option>
                <option value="shopping">è³¼ç‰©</option>
                <option value="income">æ”¶å…¥</option>
                <option value="others">å…¶ä»–</option>
              </select>
              <select id="filterType">
                <option value="all">å…¨éƒ¨</option>
                <option value="expense">æ”¯å‡º</option>
                <option value="income">æ”¶å…¥</option>
              </select>
              <select id="sortBy">
                <option value="date_desc">æ—¥æœŸï¼ˆæ–°â†’èˆŠï¼‰</option>
                <option value="date_asc">æ—¥æœŸï¼ˆèˆŠâ†’æ–°ï¼‰</option>
                <option value="amount_desc">é‡‘é¡ï¼ˆå¤§â†’å°ï¼‰</option>
                <option value="amount_asc">é‡‘é¡ï¼ˆå°â†’å¤§ï¼‰</option>
              </select>
            </div>
          </div>
          <div>
            <input id="search" class="search" placeholder="æœå°‹æ¨™é¡Œæˆ–å‚™è¨»..." />
          </div>
        </div>

        <div class="tx-list" id="txList" aria-live="polite" style="margin-top:12px;">
          <!-- transactions injected here -->
        </div>

        <div id="empty" class="empty" style="display:none;margin-top:12px;">
          ç›®å‰æ²’æœ‰ä»»ä½•è¨˜éŒ„ â€” æ–°å¢ä½ çš„ç¬¬ä¸€ç­†å¸³ç›®å§ ğŸ“
        </div>
      </div>

      <!-- small summary row -->
      <div class="summary-row">
        <div class="panel summary-card">
          <div class="muted">æœ¬æœˆæ”¶å…¥</div>
          <div class="num" id="thisMonthIncome">NT$ 0</div>
        </div>
        <div class="panel summary-card">
          <div class="muted">æœ¬æœˆæ”¯å‡º</div>
          <div class="num" id="thisMonthExpense">NT$ 0</div>
        </div>
        <div class="panel summary-card">
          <div class="muted">ç­†æ•¸</div>
          <div class="num" id="countAll">0</div>
        </div>
      </div>

    </section>
  </main>

<script>
/* -------------------------
  Data structure & storage
  ------------------------- */
const STORAGE_KEY = "vision_expense_v1";

let transactions = []; // {id, title, note, amount, type, category, date}
let editingId = null;

/* -------------------------
  Helpers
  ------------------------- */
const $ = (sel) => document.querySelector(sel);
const $all = (sel) => Array.from(document.querySelectorAll(sel));

function uid(){
  return Date.now().toString(36) + Math.random().toString(36).slice(2,8);
}
function fmtCurrency(n){
  const sign = n < 0 ? "-" : "";
  return sign + "NT$ " + Math.abs(n).toLocaleString('zh-TW', {minimumFractionDigits: 0, maximumFractionDigits: 2});
}
function saveToStorage(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(transactions));
}
function loadFromStorage(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw) transactions = JSON.parse(raw);
    else transactions = [];
  }catch(e){
    console.error("load error", e);
    transactions = [];
  }
}

/* -------------------------
  CRUD
  ------------------------- */
function addOrUpdateTx(data){
  if(editingId){
    const idx = transactions.findIndex(t => t.id === editingId);
    if(idx >= 0){
      transactions[idx] = {...transactions[idx], ...data};
      editingId = null;
      $("#saveBtn").textContent = "æ–°å¢";
    }
  } else {
    transactions.unshift({...data, id: uid()});
  }
  saveToStorage();
  render();
}

function deleteTx(id){
  transactions = transactions.filter(t => t.id !== id);
  saveToStorage();
  render();
}

function startEdit(id){
  const t = transactions.find(x=>x.id===id);
  if(!t) return;
  editingId = id;
  $("#title").value = t.title;
  $("#amount").value = Math.abs(t.amount);
  $("#note").value = t.note || "";
  $("#category").value = t.category;
  $("#type").value = t.type;
  $("#date").value = t.date ? t.date.slice(0,10) : "";
  $("#saveBtn").textContent = "å„²å­˜è®Šæ›´";
  window.scrollTo({top:0,behavior:"smooth"});
}

/* -------------------------
  Rendering
  ------------------------- */
function render(){
  // filters
  const filterCategory = $("#filterCategory").value;
  const filterType = $("#filterType").value;
  const search = $("#search").value.trim().toLowerCase();
  const sortBy = $("#sortBy").value;

  let list = transactions.slice();

  // search
  if(search){
    list = list.filter(t => (t.title || "").toLowerCase().includes(search) || (t.note || "").toLowerCase().includes(search));
  }
  // category filter
  if(filterCategory !== "all"){
    list = list.filter(t => t.category === filterCategory);
  }
  // type filter
  if(filterType !== "all"){
    list = list.filter(t => t.type === filterType);
  }

  // sort
  list.sort((a,b) => {
    if(sortBy === "date_desc") return (new Date(b.date || b._created||b.id)) - (new Date(a.date || a._created||a.id));
    if(sortBy === "date_asc") return (new Date(a.date || a._created||a.id)) - (new Date(b.date || b._created||b.id));
    if(sortBy === "amount_desc") return Math.abs(b.amount) - Math.abs(a.amount);
    if(sortBy === "amount_asc") return Math.abs(a.amount) - Math.abs(b.amount);
    return 0;
  });

  const txList = $("#txList");
  txList.innerHTML = "";
  if(list.length === 0){
    $("#empty").style.display = "block";
  } else {
    $("#empty").style.display = "none";
  }

  for(const t of list){
    const card = document.createElement("div");
    card.className = "tx";
    const date = t.date ? new Date(t.date) : null;
    const dateStr = date ? `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,"0")}-${String(date.getDate()).padStart(2,"0")}` : "";

    const typeTag = t.type === "income" ? '<span class="tag">æ”¶å…¥</span>' : '<span class="tag">æ”¯å‡º</span>';
    const catTag = `<span class="tag">${t.category}</span>`;

    card.innerHTML = `
      <div class="meta">
        <div class="title">${escapeHtml(t.title)} ${catTag}</div>
        <div class="desc">${escapeHtml(t.note || "")} <span class="muted">${dateStr}</span></div>
      </div>
      <div class="amount ${t.type === 'income'? 'positive' : 'negative'}">${t.type === 'income' ? '+' : '-'} ${Number(t.amount).toLocaleString()}</div>
      <div class="actions">
        <button class="icon-btn" title="ç·¨è¼¯" data-id="${t.id}" aria-label="ç·¨è¼¯"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
        <button class="icon-btn" title="åˆªé™¤" data-del="${t.id}" aria-label="åˆªé™¤"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M3 6h18M8 6v12a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2V6M10 6V4a2 2 0 0 1 2-2h0a2 2 0 0 1 2 2v2" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
      </div>
    `;
    txList.appendChild(card);
  }

  // bind action buttons
  $all('.icon-btn[title="ç·¨è¼¯"]').forEach(el => el.addEventListener('click', e => startEdit(e.currentTarget.dataset.id)));
  $all('.icon-btn[title="åˆªé™¤"]').forEach(el => el.addEventListener('click', e => {
    const id = e.currentTarget.dataset.del;
    if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜éŒ„å—ï¼Ÿ')) deleteTx(id);
  }));

  updateSummary();
}

/* -------------------------
  Stats / summary
  ------------------------- */
function updateSummary(){
  const totalIncome = transactions.filter(t=>t.type==='income').reduce((s,t)=>s + Number(t.amount),0);
  const totalExpense = transactions.filter(t=>t.type==='expense').reduce((s,t)=>s + Number(t.amount),0);
  const balance = totalIncome - totalExpense;

  $("#total-income").textContent = fmtCurrency(totalIncome);
  $("#total-expense").textContent = fmtCurrency(totalExpense);
  $("#balance").textContent = fmtCurrency(balance);

  // this month summary
  const now = new Date();
  const thisMonthIncome = transactions.filter(t=>t.type==='income' && new Date(t.date || t.id).getMonth()===now.getMonth() && new Date(t.date || t.id).getFullYear()===now.getFullYear()).reduce((s,t)=>s + Number(t.amount),0);
  const thisMonthExpense = transactions.filter(t=>t.type==='expense' && new Date(t.date || t.id).getMonth()===now.getMonth() && new Date(t.date || t.id).getFullYear()===now.getFullYear()).reduce((s,t)=>s + Number(t.amount),0);

  $("#thisMonthIncome").textContent = fmtCurrency(thisMonthIncome);
  $("#thisMonthExpense").textContent = fmtCurrency(thisMonthExpense);
  $("#countAll").textContent = transactions.length;
}

/* -------------------------
  Form handling
  ------------------------- */
document.getElementById('txForm').addEventListener('submit', function(e){
  e.preventDefault();
  const title = $("#title").value.trim();
  const amt = Number($("#amount").value);
  const note = $("#note").value.trim();
  const category = $("#category").value;
  const type = $("#type").value;
  const date = $("#date").value || (new Date()).toISOString();

  if(!title || !amt || amt <= 0){
    alert('è«‹è¼¸å…¥åˆç†çš„æ¨™é¡Œèˆ‡é‡‘é¡ï¼ˆ>0ï¼‰');
    return;
  }

  // store amount positive and type marks whether income/expense
  addOrUpdateTx({ title, amount: amt, note, category, type, date });
  // reset form
  this.reset();
  editingId = null;
  $("#saveBtn").textContent = "æ–°å¢";
});

$("#resetBtn").addEventListener('click', function(){
  document.getElementById('txForm').reset();
  editingId = null;
  $("#saveBtn").textContent = "æ–°å¢";
});

/* -------------------------
  Filters / search bindings
  ------------------------- */
["#filterCategory","#filterType","#sortBy"].forEach(sel => {
  $(sel).addEventListener('change', render);
});
$("#search").addEventListener('input', debounce(render, 220));

/* -------------------------
  Export / Import
  ------------------------- */
$("#exportBtn").addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(transactions, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'transactions.json';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});
$("#importBtn").addEventListener('click', ()=>{
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'application/json';
  input.onchange = (ev) => {
    const file = ev.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const data = JSON.parse(reader.result);
        if(Array.isArray(data)){
          // basic validation
          const safe = data.every(d => d.title && d.amount && d.type);
          if(!safe) throw new Error('æ ¼å¼éŒ¯èª¤');
          transactions = data;
          saveToStorage();
          render();
          alert('åŒ¯å…¥å®Œæˆ');
        } else {
          alert('æª”æ¡ˆä¸æ˜¯æœ‰æ•ˆçš„äº¤æ˜“åˆ—è¡¨');
        }
      }catch(err){
        alert('åŒ¯å…¥å¤±æ•—ï¼š' + err.message);
      }
    };
    reader.readAsText(file);
  };
  input.click();
});

/* -------------------------
  Utilities
  ------------------------- */
function debounce(fn, ms=200){
  let t;
  return function(...a){ clearTimeout(t); t = setTimeout(()=>fn.apply(this,a), ms); };
}
function escapeHtml(s){
  if(!s) return "";
  return s.replace(/[&<>"']/g, function(m){
    return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m]);
  });
}

/* -------------------------
  Init
  ------------------------- */
(function init(){
  loadFromStorage();
  render();
  // default date to today in form
  const dt = new Date().toISOString().slice(0,10);
  $("#date").value = dt;
})();

</script>
</body>
</html>
