<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>輸贏紀錄器</title>
<style>
  :root { --gap: 10px; }
  body {
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", sans-serif;
    margin: 20px; background:#f6f7fb; color:#222;
  }
  .wrap { max-width: 460px; margin: 0 auto; }
  h1 { font-size: 22px; font-weight: 800; margin: 0 0 12px; }

  /* 剩餘金幣 */
  .balance {
    background:#fff; border-radius:12px; padding:16px;
    display:flex; align-items:baseline; justify-content:space-between;
    box-shadow: 0 2px 8px rgba(0,0,0,.05);
  }
  .balance .label { color:#666; font-size:16px; }
  .balance .value {
    font-size: 42px;
    font-weight: 900;
    letter-spacing:.5px;
    transition: color 0.2s ease;
  }
  .balance.positive .value { color:#ffcc00; }   /* 黃色 */
  .balance.zero .value { color:#888; }          /* 灰色 */
  .balance.negative .value { color:#d33; }      /* 紅色 */

  .topbar {
    display:flex; align-items:center; justify-content:space-between;
    margin: 12px 0 16px;
  }
  .mode-indicator { font-size:14px; color:#444; }
  .mode-indicator strong { padding:4px 8px; border-radius:8px; font-size:15px; }
  .mode-win strong { background:#e8f9ef; color:#0a7a3f; }
  .mode-lose strong { background:#ffecec; color:#b11212; }

  .btn {
    display:inline-flex; align-items:center; justify-content:center;
    border:none; background:#eef2f7; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:700;
    font-size:14px;
  }
  .btn:hover { filter:brightness(.97); }
  .btn-danger { background:#ffe8e8; }

  .pad { display:grid; grid-template-columns: repeat(3, 1fr); gap: var(--gap); }
  .key {
    background:#fff; border:1px solid #e5e7eb; border-radius:12px;
    padding:20px 0; font-size:26px; font-weight:800; text-align:center; cursor:pointer;
    user-select:none; box-shadow: 0 1px 4px rgba(0,0,0,.04);
    transition: transform .02s ease-in;
  }
  .key:active { transform: scale(.98); }
  .key.action-win { background:#eefdf2; border-color:#c8f1d6; }
  .key.action-lose { background:#fff1f1; border-color:#ffd3d3; }

  .section {
    margin-top: 18px; background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:12px;
    box-shadow: 0 2px 8px rgba(0,0,0,.04);
  }
  .section h2 { font-size:18px; margin:0 0 8px; }

  #currentInput {
    font-size: 38px;
    font-weight: 900;
  }

  .history { max-height: 320px; overflow:auto; }
  .row {
    display:grid;
    grid-template-columns: 110px 1fr 120px 68px;
    gap:8px; padding:10px 0; border-bottom:1px dashed #eee;
    font-size:14px; align-items:center;
  }
  .row:last-child { border-bottom:none; }
  .amt.plus { color:#0a7a3f; font-weight:800; }
  .amt.minus { color:#b11212; font-weight:800; }
  .muted { color:#888; font-size:12px; }
  .del-btn { padding:8px 10px; font-size:12px; border-radius:8px; }
</style>
</head>
<body>
  <div class="wrap">
    <h1>輸贏紀錄器</h1>

    <div class="balance" id="balanceBox" aria-live="polite">
      <div class="label">剩餘金幣</div>
      <div class="value" id="balance">0</div>
    </div>

    <div class="topbar">
      <div class="mode-indicator" id="modeText">目前模式：<strong>未選擇</strong></div>
      <button id="resetAll" class="btn btn-danger" title="清空金額與歷史">重設</button>
    </div>

    <div class="pad" id="pad">
      <div class="key" data-key="1">1</div>
      <div class="key" data-key="2">2</div>
      <div class="key" data-key="3">3</div>
      <div class="key" data-key="4">4</div>
      <div class="key" data-key="5">5</div>
      <div class="key" data-key="6">6</div>
      <div class="key" data-key="7">7</div>
      <div class="key" data-key="8">8</div>
      <div class="key" data-key="9">9</div>
      <div class="key action-win" data-action="win">贏</div>
      <div class="key" data-key="0">0</div>
      <div class="key action-lose" data-action="lose">輸</div>
    </div>

    <div class="section">
      <h2>本次金額：</h2>
      <div id="currentInput">0</div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
        <button id="backspace" class="btn">退格</button>
        <button id="clearInput" class="btn">清零</button>
      </div>
    </div>

    <div class="section">
      <h2>紀錄</h2>
      <div class="history" id="history"></div>
    </div>
  </div>

<script>
(function() {
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  const balanceBox = $('#balanceBox');
  const balanceEl = $('#balance');
  const modeText = $('#modeText');
  const currentInputEl = $('#currentInput');
  const historyEl = $('#history');

  const resetAllBtn = $('#resetAll');
  const backspaceBtn = $('#backspace');
  const clearInputBtn = $('#clearInput');

  const STORAGE_KEY = 'winloss_recorder_v1';
  let state = loadState();

  renderAll();

  // --- keypad ---
  $$('#pad .key').forEach(btn => {
    btn.addEventListener('click', () => {
      const k = btn.dataset.key;
      const action = btn.dataset.action;

      if (k !== undefined && k !== null) {
        appendDigit(k);
      } else if (action === 'win' || action === 'lose') {
        if (!state.buffer || Number(state.buffer) === 0) {
          setMode(action);
        } else {
          apply(action);
        }
      }
    });
  });

  // --- controls ---
  resetAllBtn.addEventListener('click', () => {
    if (!confirm('確定要清空剩餘金幣與所有紀錄嗎？')) return;
    state = { balance: 0, buffer: '0', mode: null, history: [] };
    saveState(); renderAll();
  });

  backspaceBtn.addEventListener('click', () => {
    if (!state.buffer || state.buffer === '0') return;
    state.buffer = state.buffer.slice(0, -1);
    if (state.buffer.length === 0) state.buffer = '0';
    saveState(); renderInput();
  });

  clearInputBtn.addEventListener('click', () => {
    state.buffer = '0';
    saveState(); renderInput();
  });

  // --- delete record ---
  historyEl.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-del-index]');
    if (!btn) return;
    const idx = Number(btn.dataset.delIndex);
    if (Number.isNaN(idx)) return;
    state.history.splice(idx, 1);
    recomputeBalanceAndAfter();
    saveState(); renderAll();
  });

  // --- keyboard support ---
  window.addEventListener('keydown', (e) => {
    if (e.key >= '0' && e.key <= '9') {
      appendDigit(e.key);
    } else if (e.key === 'Enter') {
      if (Number(state.buffer) > 0) {
        apply(state.mode || 'win');
      }
    } else if (e.key === 'Backspace') {
      backspaceBtn.click();
    } else if (e.key.toLowerCase() === 'w') {
      apply('win');
    } else if (e.key.toLowerCase() === 'l') {
      apply('lose');
    }
  });

  // --- helpers ---
  function appendDigit(d) {
    if (state.buffer === '0') state.buffer = d;
    else state.buffer += d;
    saveState(); renderInput();
  }

  function setMode(m) {
    state.mode = m;
    saveState(); renderMode();
  }

  function apply(type) {
    const amt = Number(state.buffer || '0');
    if (!amt) return;

    state.history.unshift({ t: Date.now(), type, amount: amt });
    state.buffer = '0';
    state.mode = type;

    recomputeBalanceAndAfter();
    saveState(); renderAll();
  }

  function recomputeBalanceAndAfter() {
    let running = 0;
    for (let i = state.history.length - 1; i >= 0; i--) {
      const rec = state.history[i];
      const delta = rec.type === 'win' ? rec.amount : -rec.amount;
      running += delta;
      rec.after = running;
    }
    state.balance = running;
  }

  function renderAll() {
    renderBalance();
    renderMode();
    renderInput();
    renderHistory();
  }

  function renderBalance() {
    balanceEl.textContent = formatNumber(state.balance);
    balanceBox.classList.remove('positive','zero','negative');
    if (state.balance > 0) balanceBox.classList.add('positive');
    else if (state.balance < 0) balanceBox.classList.add('negative');
    else balanceBox.classList.add('zero');
  }

  function renderMode() {
    if (state.mode === 'win') {
      modeText.classList.add('mode-win');
      modeText.classList.remove('mode-lose');
      modeText.innerHTML = '目前模式：<strong>贏（加）</strong>';
    } else if (state.mode === 'lose') {
      modeText.classList.add('mode-lose');
      modeText.classList.remove('mode-win');
      modeText.innerHTML = '目前模式：<strong>輸（減）</strong>';
    } else {
      modeText.classList.remove('mode-win', 'mode-lose');
      modeText.innerHTML = '目前模式：<strong>未選擇</strong>';
    }
  }

  function renderInput() {
    currentInputEl.textContent = formatNumber(Number(state.buffer || 0));
  }

  function renderHistory() {
    historyEl.innerHTML = '';
    if (!state.history.length) {
      historyEl.innerHTML = '<div class="muted">目前尚無紀錄</div>';
      return;
    }
    state.history.forEach((rec, idx) => {
      const row = document.createElement('div');
      row.className = 'row';
      const date = new Date(rec.t);
      const yyyy = date.getFullYear();
      const mm = String(date.getMonth()+1).padStart(2,'0');
      const dd = String(date.getDate()).padStart(2,'0');
      const hh = String(date.getHours()).padStart(2,'0');
      const mi = String(date.getMinutes()).padStart(2,'0');
      const ss = String(date.getSeconds()).padStart(2,'0');
      const timeStr = `${yyyy}/${mm}/${dd} ${hh}:${mi}:${ss}`;

      const timeCol = document.createElement('div');
      timeCol.innerHTML = `<span class="muted">${timeStr}</span>`;

      const typeCol = document.createElement('div');
      const sign = rec.type === 'win' ? '+' : '-';
      typeCol.innerHTML = `<span class="amt ${rec.type==='win'?'plus':'minus'}">${sign}${formatNumber(rec.amount)}</span>`;

      const afterCol = document.createElement('div');
      afterCol.innerHTML = `<span class="muted">剩餘：${formatNumber(rec.after ?? 0)}</span>`;

      const delCol = document.createElement('div');
      delCol.style.textAlign = 'right';
      delCol.innerHTML = `<button class="btn del-btn btn-danger" data-del-index="${idx}">刪除</button>`;

      row.appendChild(timeCol);
      row.appendChild(typeCol);
      row.appendChild(afterCol);
      row.appendChild(delCol);
      historyEl.appendChild(row);
    });
  }

  function formatNumber(n) {
    return Number(n).toLocaleString('zh-Hant-TW');
  }

  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        return { balance: 0, buffer: '0', mode: null, history: [] };
      }
      const s = JSON.parse(raw);
      const st = {
        balance: Number(s.balance) || 0,
        buffer: typeof s.buffer === 'string' ? s.buffer : '0',
        mode: (s.mode === 'win' || s.mode === 'lose') ? s.mode : null,
        history: Array.isArray(s.history) ? s.history : []
      };
      recomputeBalanceAndAfterFrom(st);
      return st;
    } catch {
      return { balance: 0, buffer: '0', mode: null, history: [] };
    }
  }

  function recomputeBalanceAndAfterFrom(st) {
    let running = 0;
    for (let i = st.history.length - 1; i >= 0; i--) {
      const rec = st.history[i];
      const delta = rec.type === 'win' ? rec.amount : -rec.amount;
      running += delta;
      rec.after = running;
    }
    st.balance = running;
  }

  function saveState() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }
})();
</script>
</body>
</html>
