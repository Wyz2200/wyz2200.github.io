<!doctype html>
<html lang="zh-Hant">
<head>
  <link rel="apple-touch-icon" href="icon.png">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è¼¸è´ç´€éŒ„å™¨ ğŸ€„ï¸</title>
<style>
  :root {
    --gap: 10px;
    --bg: #f6f7fb;
    --fg: #222;
    --card: #fff;
    --muted: #888;
    --border: #e5e7eb;
    --btn: #eef2f7;
    --plus: #0a7a3f;
    --minus: #b11212;
    --gold: #ffcc00;
    --danger: #d33;
  }

  /* æš—è‰²ä¸»é¡Œè¦†å¯«ï¼ˆå¥—åœ¨ <body class="dark-mode">ï¼‰ */
  body.dark-mode {
    --bg: #0f1115;
    --fg: #e7e9ee;
    --card: #151a21;
    --muted: #a7adbb;
    --border: #2a313b;
    --btn: #1c2330;
  }

  body {
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", sans-serif;
    margin: 20px;
    background: var(--bg);
    color: var(--fg);
    transition: background .2s ease, color .2s ease;
  }
  .wrap { max-width: 460px; margin: 0 auto; }

  h1 { font-size: 32px; font-weight: 800; margin: 0 0 12px; text-align: left; }

  /* å‰©é¤˜é‡‘å¹£ */
  .balance {
    background: var(--card); border:1px solid var(--border); border-radius:16px; padding:16px;
    display:flex; align-items: center; justify-content:space-between;
    box-shadow: 0 2px 8px rgba(0,0,0,.05);
    transition: background .2s ease, border-color .2s ease, box-shadow .2s ease, transform .2s ease;
    will-change: transform, box-shadow;
  }
  .balance .label { color:#444; font-size: 22px; font-weight: 600; }
  body.dark-mode .balance .label { color: var(--fg); }
  .balance .value { font-size: 42px; font-weight: 900; letter-spacing:.5px; transition: color 0.2s ease; }
  .balance.positive .value { color: var(--gold); }
  .balance.zero .value { color: var(--muted); }
  .balance.negative .value { color: var(--danger); }

  /* è´/è¼¸å‹•ç•« */
  @keyframes flashGold {
    0%   { box-shadow: 0 0 0 rgba(255,204,0,0); transform: translateY(0); }
    10%  { box-shadow: 0 0 20px rgba(255,204,0,.6); }
    100% { box-shadow: 0 0 0 rgba(255,204,0,0); transform: translateY(0); }
  }
  @keyframes slideRed {
    0%   { box-shadow: 0 0 0 rgba(211,51,51,0); transform: translateY(-6px); }
    20%  { box-shadow: 0 0 22px rgba(211,51,51,.55); }
    100% { box-shadow: 0 0 0 rgba(211,51,51,0); transform: translateY(0); }
  }
  .flash-win { animation: flashGold .6s ease; }
  .flash-lose { animation: slideRed .6s ease; }

  .divider{ height:1px; background: var(--border); margin: 8px 0; border: 0; }

  .topbar { display:flex; align-items:center; justify-content:space-between; margin: 12px 0 16px; }
  .mode-indicator { font-size:14px; color:#444; }
  body.dark-mode .mode-indicator { color: var(--muted); }
  .mode-indicator strong { padding:4px 8px; border-radius:8px; font-size:15px; }
  .mode-win strong { background:#e8f9ef; color:var(--plus); }
  .mode-lose strong { background:#ffecec; color:var(--danger); }

  /* é€šç”¨æŒ‰éˆ• */
  .btn {
    display:inline-flex; align-items:center; justify-content:center;
    border:none; background:var(--btn);
    padding:10px 14px; border-radius:12px; cursor:pointer;
    font-weight:700; font-size:14px; color:var(--fg);
    transition:filter 0.2s ease, background .2s ease, color .2s ease, border-color .2s ease;
  }
  .btn:hover { filter:brightness(.97); }
  .btn-danger { background:var(--btn); color: var(--danger); }
  .btn-ghost { background: transparent; border: 1px solid var(--border); }

  /* è‰²å¡ŠæŒ‰éˆ• */
  .color-btn { padding: 6px 10px; }
  .color-btn .swatch {
    width: 20px; height: 20px; border-radius: 50%;
    border: 2px solid var(--border); display: inline-block;
  }

  .pad { display:grid; grid-template-columns: repeat(3, 1fr); gap: var(--gap); }
  .section + .pad { margin-top: 10px; }
  .key {
    background:var(--card); border:1px solid var(--border); border-radius:16px;
    padding:20px 0; font-size:26px; font-weight:800; text-align:center; cursor:pointer;
    user-select:none; box-shadow: 0 1px 4px rgba(0,0,0,.04);
    transition: transform .02s ease-in, background .2s ease, border-color .2s ease, color .2s ease;
  }
  .key:active { transform: scale(.98); }
  .key.action-win { background:#eefdf2; border-color:#c8f1d6; }
  .key.action-lose { background:#fff1f1; border-color:#ffd3d3; }
  body.dark-mode .key.action-win { background:#15331f; border-color:#194e2b; }
  body.dark-mode .key.action-lose { background:#3a1b1b; border-color:#5e2a2a; }

  /* å€å¡Šå¡ç‰‡ */
  .section {
    margin-top: 18px; background:var(--card); border:1px solid var(--border); border-radius:18px; padding:12px;
    box-shadow: 0 2px 8px rgba(0,0,0,.04);
    transition: background .2s ease, border-color .2s ease;
  }
  .section h2 {
    display:flex; align-items:center; justify-content:space-between;
    margin:0 0 8px; font-size:18px;
  }
  /* åªæœ‰æœ€å¾Œä¸€å¡Šï¼ˆç´€éŒ„ï¼‰ä¸‹ç·£åœ“è§’æ›´å¤§ã€è€Œä¸”é è¨­é«˜ä¸€äº› */
  .wrap > .section:last-of-type { border-radius: 18px 18px 42px 42px; min-height: 153px; }

  /* æœ¬æ¬¡é‡‘é¡ èˆ‡ æŒ‰éˆ•åŒä¸€è¡Œ */
  .amount-line { display:flex; align-items:center; justify-content:space-between; gap:12px; }
  #currentInput { font-size: 38px; font-weight: 900; }
  .amount-actions { display:flex; gap:8px; }

  /* ç´€éŒ„å€ */
  .history { max-height: 320px; overflow:auto; }
  .row {
    display: grid;
    grid-template-columns: 30px 90px 1fr 90px 68px; /* ç·¨è™Ÿ | æ™‚é–“ | é‡‘é¡ | é¤˜ | åˆªé™¤ */
    gap: 8px;
    padding: 12px 0;
    border-bottom: 1px dashed var(--border);
    font-size: 14px;
    align-items: center;
  }
  .row:last-child { border-bottom:none; }
  .amt.plus { color: var(--plus); font-weight:800; }
  .amt.minus { color: var(--minus); font-weight:800; }
  .muted { color: var(--muted); font-size:12px; }
  .del-btn { padding:8px 10px; font-size:12px; border-radius:8px; }

  /* ç¸½çµæµ®çª— */
  .modal-backdrop {
    position: fixed; inset: 0;
    background: rgba(0,0,0,.9);
    display:flex; align-items:center; justify-content:center; z-index: 9999;
    opacity: 0; visibility: hidden; pointer-events: none;
    transition: opacity .18s ease, visibility .18s ease;
  }
  body.dark-mode .modal-backdrop { background: rgba(0,0,0,.45); }
  .modal-backdrop.show { opacity: 1; visibility: visible; pointer-events: auto; }
  .modal {
    width: min(86vw, 360px);
    background: var(--card); border:1px solid var(--border); border-radius:20px; box-shadow: 0 10px 30px rgba(0,0,0,.2);
    padding:16px 16px 14px; position: relative;
    transform: translateY(8px); opacity: 0;
    transition: transform .18s ease, opacity .18s ease, background .2s ease, border-color .2s ease;
  }
  .modal-backdrop.show .modal { transform: translateY(0); opacity: 1; }
  .modal h3 { margin:0 0 10px; font-size:18px; font-weight:800; }
  .modal .close {
    position:absolute; right:10px; top:8px; border:none; background:transparent;
    font-size:20px; line-height:1; cursor:pointer; color: var(--muted);
  }
  .summary-grid {
    display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:6px;
  }
  .summary-item { background:rgba(0,0,0,.03); border:1px solid var(--border); border-radius:10px; padding:10px; }
  body.dark-mode .summary-item { background: rgba(255,255,255,.03); }
  .summary-item h4 { margin:0 0 6px; font-size:13px; color: var(--muted); font-weight:700; }
  .summary-item .val { font-size:18px; font-weight:900; }
  .val.plus { color: var(--plus); }
  .val.minus { color: var(--minus); }
  .total-line {
    margin-top:12px; padding-top:10px; border-top:1px dashed var(--border);
    display:flex; align-items:baseline; justify-content:space-between;
  }
  .total-line .label { color: var(--muted); }
  .total-line .value { font-size:22px; font-weight:900; }
  .total-line .value.positive { color: var(--gold); }
  .total-line .value.zero { color: var(--muted); }
  .total-line .value.negative { color: var(--danger); }

  /* â€”â€” åº•éƒ¨ã€Œä¸»é¡Œé¡è‰²ã€é¢æ¿ â€”â€” */
  .sheet-backdrop {
    position: fixed; inset: 0;
    background: rgba(0,0,0,.35);
    opacity: 0; visibility: hidden; pointer-events: none;
    transition: opacity .18s ease, visibility .18s ease;
    z-index: 10000;
  }
  .sheet-backdrop.show { opacity: 1; visibility: visible; pointer-events: auto; }
  .sheet {
    position: absolute; left: 0; right: 0; bottom: 0;
    background: var(--card);
    border-top-left-radius: 16px; border-top-right-radius: 16px;
    border: 1px solid var(--border);
padding: 14px 14px calc(20px + env(safe-area-inset-bottom));
    transform: translateY(100%);
    transition: transform .18s ease, background .2s ease, border-color .2s ease;
  }
  .sheet-backdrop.show .sheet { transform: translateY(0); }
  .sheet header { display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; }
  .sheet header .title { font-weight: 800; }
  .sheet .grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; }
.swatch-btn {
  width: 36px; height: 36px;
  border-radius: 50%;
  background: var(--btn); /* å¤–åº•ç°è‰² */
  border: 2px solid var(--border);
  cursor: pointer;
  position: relative;
}
.swatch-btn::after {
  content: "";
  position: absolute;
  inset: 6px;              /* è®“ä¸­é–“ç•™å‡ºç°é‚Š */
  border-radius: 50%;
  background: var(--swatch-color, #fff);  /* ç”¨ JS å¯«å…¥ä¸»è‰² */
}
  .swatch-btn:focus { outline: none; box-shadow: 0 0 0 2px rgba(0,0,0,.08) inset; }
  .swatch-btn.active { box-shadow: 0 0 0 3px rgba(0,0,0,.15); }
  body.dark-mode .sheet-backdrop { background: rgba(0,0,0,.45); }
</style>
</head>
<body>
  <div class="wrap">
    <h1>â €è¼¸è´ç´€éŒ„å™¨ ğŸ€„ï¸</h1>

    <div class="balance" id="balanceBox" aria-live="polite">
      <div class="label">å‰©é¤˜é‡‘é¡</div>
      <div class="value" id="balance">0</div>
    </div>
    <div class="divider" aria-hidden="true"></div>

    <div class="topbar">
      <div class="mode-indicator" id="modeText">ç›®å‰æ¨¡å¼ï¼š<strong>æœªé¸æ“‡</strong></div>
      <div style="display:flex; gap:8px; align-items:center;">
        <!-- å–ä»£åŸæœ¬çš„äº®/æš—åˆ‡æ›æŒ‰éˆ• -->
        <button id="colorPickerBtn" class="btn btn-ghost color-btn" title="ä¸»é¡Œé¡è‰²">
          <span class="swatch" id="colorSwatch"></span>
        </button>
        <button id="resetAll" class="btn btn-danger" title="æ¸…ç©ºé‡‘é¡èˆ‡æ­·å²">é‡è¨­</button>
      </div>
    </div>

    <div class="section">
      <h2>æœ¬æ¬¡é‡‘é¡ï¼š</h2>
      <div class="amount-line">
        <div id="currentInput">0</div>
        <div class="amount-actions">
          <button id="backspace" class="btn">é€€æ ¼</button>
          <button id="clearInput" class="btn">æ¸…é›¶</button>
        </div>
      </div>
    </div>

    <div class="pad" id="pad">
      <div class="key" data-key="1">1</div>
      <div class="key" data-key="2">2</div>
      <div class="key" data-key="3">3</div>
      <div class="key" data-key="4">4</div>
      <div class="key" data-key="5">5</div>
      <div class="key" data-key="6">6</div>
      <div class="key" data-key="7">7</div>
      <div class="key" data-key="8">8</div>
      <div class="key" data-key="9">9</div>
      <div class="key action-win" data-action="win">è´</div>
      <div class="key" data-key="0">0</div>
      <div class="key action-lose" data-action="lose">è¼¸</div>
    </div>

    <div class="section">
      <h2>
        <span>ç´€éŒ„</span>
        <button id="openSummary" class="btn" title="æŸ¥çœ‹è´/è¼¸æ¬¡æ•¸èˆ‡é‡‘é¡">ç¸½çµ</button>
      </h2>
      <div class="history" id="history"></div>
    </div>
  </div>

  <!-- ç¸½çµæµ®çª— -->
  <div class="modal-backdrop" id="summaryBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="summaryTitle">
      <button class="close" id="summaryClose" aria-label="é—œé–‰">Ã—</button>
      <h3 id="summaryTitle">ç¸½çµ</h3>
      <div class="summary-grid">
        <div class="summary-item">
          <h4>è´çš„æ¬¡æ•¸</h4>
          <div class="val" id="sumWinCount">0</div>
        </div>
        <div class="summary-item">
          <h4>è¼¸çš„æ¬¡æ•¸</h4>
          <div class="val" id="sumLoseCount">0</div>
        </div>
        <div class="summary-item">
          <h4>è´éçš„é‡‘é¡</h4>
          <div class="val plus" id="sumWinAmount">+0</div>
        </div>
        <div class="summary-item">
          <h4>è¼¸éçš„é‡‘é¡</h4>
          <div class="val minus" id="sumLoseAmount">-0</div>
        </div>
      </div>
      <div class="total-line">
        <div class="label">ç¸½é‡‘é¡</div>
        <div class="value" id="sumTotalValue">0</div>
      </div>
    </div>
  </div>

  <!-- ä¸»é¡Œé¡è‰²é¢æ¿ï¼ˆåº•éƒ¨å½ˆçª—ï¼‰ -->
  <div class="sheet-backdrop" id="colorSheetBackdrop" aria-hidden="true">
    <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="colorSheetTitle">
      <header>
        <div class="title" id="colorSheetTitle">é¸æ“‡èƒŒæ™¯é¡è‰²</div>
        <button class="btn btn-ghost" id="colorSheetClose">é—œé–‰</button>
      </header>
      <div class="grid" id="colorGrid"></div>
    </div>
  </div>

<script>
(function() {
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  const balanceBox = $('#balanceBox');
  const balanceEl = $('#balance');
  const modeText = $('#modeText');
  const currentInputEl = $('#currentInput');
  const historyEl = $('#history');

  const resetAllBtn = $('#resetAll');
  const backspaceBtn = $('#backspace');
  const clearInputBtn = $('#clearInput');

  // Summary modal elements
  const openSummaryBtn = $('#openSummary');
  const summaryBackdrop = $('#summaryBackdrop');
  const summaryClose = $('#summaryClose');
  const sumWinCountEl = $('#sumWinCount');
  const sumLoseCountEl = $('#sumLoseCount');
  const sumWinAmountEl = $('#sumWinAmount');
  const sumLoseAmountEl = $('#sumLoseAmount');
  const sumTotalValueEl = $('#sumTotalValue');

  const STORAGE_KEY = 'winloss_recorder_v1';
  let state = loadState();

  renderAll();

  // --- keypad ---
  $$('#pad .key').forEach(btn => {
    btn.addEventListener('click', () => {
      const k = btn.dataset.key;
      const action = btn.dataset.action;
      if (k !== undefined && k !== null) appendDigit(k);
      else if (action === 'win' || action === 'lose') {
        if (!state.buffer || Number(state.buffer) === 0) setMode(action);
        else apply(action);
      }
    });
  });

  // --- controls ---
  resetAllBtn.addEventListener('click', () => {
    if (!confirm('ç¢ºå®šè¦æ¸…ç©ºå‰©é¤˜é‡‘å¹£èˆ‡æ‰€æœ‰ç´€éŒ„å—ï¼Ÿ')) return;
    state = { balance: 0, buffer: '0', mode: null, history: [] };
    saveState(); renderAll();
  });
  backspaceBtn.addEventListener('click', () => {
    if (!state.buffer || state.buffer === '0') return;
    state.buffer = state.buffer.slice(0, -1);
    if (state.buffer.length === 0) state.buffer = '0';
    saveState(); renderInput();
  });
  clearInputBtn.addEventListener('click', () => {
    state.buffer = '0'; saveState(); renderInput();
  });

  // --- delete record ---
  historyEl.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-del-index]');
    if (!btn) return;
    const idx = Number(btn.dataset.delIndex);
    if (Number.isNaN(idx)) return;
    state.history.splice(idx, 1);
    recomputeBalanceAndAfter();
    saveState(); renderAll();
  });

  // --- keyboard support ---
  window.addEventListener('keydown', (e) => {
    if (e.key >= '0' && e.key <= '9') appendDigit(e.key);
    else if (e.key === 'Enter' && Number(state.buffer) > 0) apply(state.mode || 'win');
    else if (e.key === 'Backspace') backspaceBtn.click();
    else if (e.key.toLowerCase() === 'w') apply('win');
    else if (e.key.toLowerCase() === 'l') apply('lose');
    else if (e.key === 'Escape') closeSummary();
  });

  // --- Summary (ç¸½çµ) ---
  openSummaryBtn.addEventListener('click', () => {
    const { winCount, loseCount, winAmount, loseAmount, total } = computeSummary();
    sumWinCountEl.textContent = formatNumber(winCount);
    sumLoseCountEl.textContent = formatNumber(loseCount);
    sumWinAmountEl.textContent = '+' + formatNumber(winAmount);
    sumLoseAmountEl.textContent = '-' + formatNumber(loseAmount);
    sumTotalValueEl.textContent = formatNumber(total);
    sumTotalValueEl.classList.remove('positive','negative','zero');
    if (total > 0) sumTotalValueEl.classList.add('positive');
    else if (total < 0) sumTotalValueEl.classList.add('negative');
    else sumTotalValueEl.classList.add('zero');
    openSummary();
  });
  summaryClose.addEventListener('click', closeSummary);
  summaryBackdrop.addEventListener('click', (e) => { if (e.target === summaryBackdrop) closeSummary(); });
  function openSummary() { summaryBackdrop.classList.add('show'); }
  function closeSummary() { summaryBackdrop.classList.remove('show'); }

  function computeSummary() {
    let winCount = 0, loseCount = 0, winAmount = 0, loseAmount = 0;
    for (const rec of state.history) {
      if (rec.type === 'win') { winCount++; winAmount += Number(rec.amount)||0; }
      else if (rec.type === 'lose') { loseCount++; loseAmount += Number(rec.amount)||0; }
    }
    return { winCount, loseCount, winAmount, loseAmount, total: winAmount - loseAmount };
  }

  // --- helpers ---
  function appendDigit(d) {
    state.buffer = (state.buffer === '0') ? d : state.buffer + d;
    saveState(); renderInput();
  }
  function setMode(m){ state.mode = m; saveState(); renderMode(); }
  function apply(type) {
    const amt = Number(state.buffer||'0'); if (!amt) return;
    state.history.unshift({ t: Date.now(), type, amount: amt });
    state.buffer = '0'; state.mode = type;
    recomputeBalanceAndAfter(); saveState(); renderAll();
    triggerBalanceFlash(type);
  }
  function triggerBalanceFlash(type) {
    const cls = (type === 'win') ? 'flash-win' : 'flash-lose';
    balanceBox.classList.remove('flash-win','flash-lose');
    void balanceBox.offsetWidth;
    balanceBox.classList.add(cls);
    setTimeout(()=> balanceBox.classList.remove(cls), 700);
  }

  function recomputeBalanceAndAfter() {
    let running = 0;
    for (let i = state.history.length-1; i>=0; i--) {
      const rec = state.history[i];
      const delta = rec.type==='win'? rec.amount : -rec.amount;
      running += delta; rec.after = running;
    }
    state.balance = running;
  }
  function renderAll(){ renderBalance(); renderMode(); renderInput(); renderHistory(); }
  function renderBalance(){
    balanceEl.textContent = formatNumber(state.balance);
    balanceBox.classList.remove('positive','zero','negative');
    if (state.balance>0) balanceBox.classList.add('positive');
    else if (state.balance<0) balanceBox.classList.add('negative');
    else balanceBox.classList.add('zero');
  }
  function renderMode(){
    if (state.mode==='win'){ modeText.classList.add('mode-win'); modeText.classList.remove('mode-lose');
      modeText.innerHTML='ç›®å‰æ¨¡å¼ï¼š<strong>è´ï¼ˆåŠ ï¼‰</strong>'; }
    else if (state.mode==='lose'){ modeText.classList.add('mode-lose'); modeText.classList.remove('mode-win');
      modeText.innerHTML='ç›®å‰æ¨¡å¼ï¼š<strong>è¼¸ï¼ˆæ¸›ï¼‰</strong>'; }
    else { modeText.classList.remove('mode-win','mode-lose');
      modeText.innerHTML='ç›®å‰æ¨¡å¼ï¼š<strong>æœªé¸æ“‡</strong>'; }
  }
  function renderInput(){ currentInputEl.textContent = formatNumber(Number(state.buffer||0)); }

  function formatTimeShort(d){
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    const hh = String(d.getHours()).padStart(2,'0');
    const mi = String(d.getMinutes()).padStart(2,'0');
    return `${mm}/${dd} ${hh}:${mi}`;
  }

  function renderHistory(){
    historyEl.innerHTML='';
    if(!state.history.length){ historyEl.innerHTML='<div class="muted">ç›®å‰å°šç„¡ç´€éŒ„</div>'; return; }
    const totalRecords = state.history.length;
    state.history.forEach((rec,idx)=>{
      const row=document.createElement('div'); row.className='row';

      const numberCol=document.createElement('div'); numberCol.className='num';
      numberCol.textContent = (totalRecords-idx).toString() + '.';

      const date=new Date(rec.t);
      const timeCol=document.createElement('div');
      timeCol.innerHTML=`<span class="muted">${formatTimeShort(date)}</span>`;

      const typeCol=document.createElement('div');
      const sign=rec.type==='win'?'+':'-';
      typeCol.innerHTML=`<span class="amt ${rec.type==='win'?'plus':'minus'}">${sign}${formatNumber(rec.amount)}</span>`;

      const afterCol=document.createElement('div');
      afterCol.innerHTML=`<span class="muted">é¤˜ï¼š${formatNumber(rec.after??0)}</span>`;

      const delCol=document.createElement('div'); delCol.style.textAlign='right';
      delCol.innerHTML=`<button class="btn del-btn btn-danger" data-del-index="${idx}">åˆªé™¤</button>`;

      row.append(numberCol,timeCol,typeCol,afterCol,delCol);
      historyEl.appendChild(row);
    });
  }

  function formatNumber(n){ return Number(n).toLocaleString('zh-Hant-TW'); }

  function loadState(){
    try{
      const raw=localStorage.getItem(STORAGE_KEY);
      if(!raw)return{balance:0,buffer:'0',mode:null,history:[]};
      const s=JSON.parse(raw);
      const st={balance:Number(s.balance)||0,buffer:typeof s.buffer==='string'?s.buffer:'0',
        mode:(s.mode==='win'||s.mode==='lose')?s.mode:null,history:Array.isArray(s.history)?s.history:[]};
      recomputeBalanceAndAfterFrom(st); return st;
    }catch{ return{balance:0,buffer:'0',mode:null,history:[]}; }
  }
  function recomputeBalanceAndAfterFrom(st){
    let running=0;
    for(let i=st.history.length-1;i>=0;i--){
      const rec=st.history[i];
      const delta=rec.type==='win'?rec.amount:-rec.amount;
      running+=delta; rec.after=running;
    } st.balance=running;
  }
  function saveState(){ localStorage.setItem(STORAGE_KEY,JSON.stringify(state)); }

  /* ====== ä¸»é¡Œé¡è‰²é¢æ¿ï¼ˆè‰²ç¥¨ï¼‰ ====== */
  const colorPickerBtn = $('#colorPickerBtn');
  const colorSwatch = $('#colorSwatch');
  const colorSheetBackdrop = $('#colorSheetBackdrop');
  const colorSheetClose = $('#colorSheetClose');
  const colorGrid = $('#colorGrid');

  const THEME_KEY = 'winloss_theme_mode';     // 'light' | 'dark'
  const BG_KEY = 'winloss_bg_color';

  // é è¨­è‰²ç¥¨ï¼ˆå«äº®/æš—ï¼‰
const PRESETS = [
  // äº®è‰²ç³»
  { name:'Default',  color:'#f6f7fb', dark:false },
  { name:'Warm',     color:'#fff7e8', dark:false },
  { name:'Mint',     color:'#eafff2', dark:false },
  { name:'Sky',      color:'#eaf5ff', dark:false },
  { name:'Blush',    color:'#ffeaf0', dark:false },
  { name:'Olive',    color:'#f3ffe9', dark:false },

  // æ·±è‰²ç³»ï¼ˆå·®ç•°æ›´æ˜é¡¯ï¼‰
  { name:'Graphite', color:'#0f1115', dark:true  },
  { name:'Navy',     color:'#0d1324', dark:true  },
  { name:'Teal',     color:'#082420', dark:true  },
  { name:'Maroon',   color:'#240f0f', dark:true  },
  { name:'Indigo',   color:'#1b1033', dark:true  },
  { name:'Slate',    color:'#1b1e26', dark:true  }
];

  initColorPanel();

  function initColorPanel() {
    // å»ºè‰²ç¥¨
    colorGrid.innerHTML = '';
    PRESETS.forEach((p) => {
      const btn = document.createElement('button');
      btn.className = 'swatch-btn';
btn.style.setProperty('--swatch-color', p.color);
      btn.title = p.name;
      btn.dataset.color = p.color;
      btn.dataset.dark = p.dark ? '1' : '0';
      btn.addEventListener('click', () => applyThemeColor(p.color, p.dark));
      colorGrid.appendChild(btn);
    });

    // è¼‰å…¥ä¸Šæ¬¡è¨­å®š
    const savedColor = localStorage.getItem(BG_KEY);
    const savedMode = localStorage.getItem(THEME_KEY); // 'dark'|'light'
    if (savedMode === 'dark') document.body.classList.add('dark-mode');
    else document.body.classList.remove('dark-mode');

    if (savedColor) {
      document.documentElement.style.setProperty('--bg', savedColor);
      colorSwatch.style.background = savedColor;
      markActiveSwatch(savedColor);
    } else {
      colorSwatch.style.background = getComputedStyle(document.documentElement).getPropertyValue('--bg').trim();
      markActiveSwatch(colorSwatch.style.background);
    }

    // é–‹é—œé¢æ¿
    colorPickerBtn.addEventListener('click', openColorSheet);
    colorSheetClose.addEventListener('click', closeColorSheet);
    colorSheetBackdrop.addEventListener('click', (e) => { if (e.target === colorSheetBackdrop) closeColorSheet(); });
  }

  function openColorSheet() { colorSheetBackdrop.classList.add('show'); }
  function closeColorSheet() { colorSheetBackdrop.classList.remove('show'); }

  function applyThemeColor(color, isDark) {
    document.documentElement.style.setProperty('--bg', color);
    localStorage.setItem(BG_KEY, color);
    colorSwatch.style.background = color;

    if (isDark) {
      document.body.classList.add('dark-mode');
      localStorage.setItem(THEME_KEY, 'dark');
    } else {
      document.body.classList.remove('dark-mode');
      localStorage.setItem(THEME_KEY, 'light');
    }

    markActiveSwatch(color);
    closeColorSheet();
  }

  // ç”¨é¡è‰²æ¯”å°åš active æ¨™è¨˜ï¼ˆæŠŠ #fff/#ffffff å·®ç•°çµ±ä¸€æˆ rgb å¾Œæ¯”è¼ƒï¼‰
  function markActiveSwatch(color) {
    [...colorGrid.querySelectorAll('.swatch-btn')].forEach(b => b.classList.remove('active'));

    const normalize = (c) => {
      const tmp = document.createElement('div');
      tmp.style.color = c; document.body.appendChild(tmp);
      const out = getComputedStyle(tmp).color; document.body.removeChild(tmp);
      return out;
    };
    const want = normalize(color);

    const btn = [...colorGrid.querySelectorAll('.swatch-btn')].find(b => normalize(b.style.background) === want);
    if (btn) btn.classList.add('active');
  }
})();
</script>
</body>
</html>
